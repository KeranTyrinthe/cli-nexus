const { BaseArchitecture } = require('../core/base-architecture');
const path = require('path');

/**
 * Clean Architecture
 * Organisation en couches m√©tier avec s√©paration des responsabilit√©s
 */
class CleanArchitecture extends BaseArchitecture {
  constructor() {
    super();
    this.name = 'clean';
    this.displayName = 'Clean Architecture';
    this.description = 'Architecture en couches avec s√©paration claire des responsabilit√©s m√©tier';
    this.features = [
      'S√©paration en couches (Entities, Use Cases, Interfaces, Frameworks)',
      'Ind√©pendance des frameworks',
      'Testabilit√© √©lev√©e',
      'Inversion de d√©pendances'
    ];
  }

  /**
   * G√©n√®re la structure Clean Architecture compl√®te
   */
  async generate(targetDir, config) {
    this.validateConfig(config);
    
    // Cr√©ation de la structure des dossiers
    await this.createDirectoryStructure(targetDir);
    
    // G√©n√©ration des fichiers de base
    await this.generateBaseFiles(targetDir, config);
    
    // G√©n√©ration des fichiers sp√©cifiques Clean Architecture
    await this.generateArchitectureFiles(targetDir, config);
  }

  /**
   * Cr√©e la structure des dossiers Clean Architecture
   */
  async createDirectoryStructure(targetDir) {
    const directories = [
      'src/domain/entities',
      'src/domain/value-objects',
      'src/domain/repositories',
      'src/application/use-cases',
      'src/application/services',
      'src/application/dto',
      'src/infrastructure/database',
      'src/infrastructure/repositories',
      'src/infrastructure/http',
      'src/infrastructure/config',
      'src/presentation/controllers',
      'src/presentation/middleware',
      'src/presentation/routes',
      'src/shared/utils',
      'src/shared/errors'
    ];

    for (const dir of directories) {
      await this.ensureDirectory(path.join(targetDir, dir));
    }
  }

  /**
   * G√©n√®re les fichiers de base du projet
   */
  async generateBaseFiles(targetDir, config) {
    // package.json
    const packageJson = this.getPackageJsonTemplate(config);
    await this.writeFile(path.join(targetDir, 'package.json'), packageJson);

    // README.md
    const readme = this.getReadmeTemplate(config);
    await this.writeFile(path.join(targetDir, 'README.md'), readme);

    // .gitignore
    const gitignore = this.getGitignoreTemplate();
    await this.writeFile(path.join(targetDir, '.gitignore'), gitignore);
  }

  /**
   * G√©n√®re les fichiers sp√©cifiques √† Clean Architecture
   */
  async generateArchitectureFiles(targetDir, config) {
    // Point d'entr√©e principal
    const appJs = this.getAppJsTemplate(config);
    await this.writeFile(path.join(targetDir, 'src/app.js'), appJs);

    // Serveur
    const serverJs = this.getServerJsTemplate(config);
    await this.writeFile(path.join(targetDir, 'src/server.js'), serverJs);

    // Entit√© de base
    const entityBase = this.getEntityBaseTemplate(config);
    await this.writeFile(path.join(targetDir, 'src/domain/entities/base.entity.js'), entityBase);

    // Use Case de base
    const useCaseBase = this.getUseCaseBaseTemplate(config);
    await this.writeFile(path.join(targetDir, 'src/application/use-cases/base.use-case.js'), useCaseBase);

    // Repository de base
    const repositoryBase = this.getRepositoryBaseTemplate(config);
    await this.writeFile(path.join(targetDir, 'src/domain/repositories/base.repository.js'), repositoryBase);

    // Contr√¥leur de base
    const controllerBase = this.getControllerBaseTemplate(config);
    await this.writeFile(path.join(targetDir, 'src/presentation/controllers/base.controller.js'), controllerBase);

    // Routes principales
    const routesIndex = this.getRoutesIndexTemplate(config);
    await this.writeFile(path.join(targetDir, 'src/presentation/routes/index.js'), routesIndex);
  }

  // Templates des fichiers
  getPackageJsonTemplate(config) {
    return JSON.stringify({
      name: config.projectName,
      version: "1.0.0",
      description: config.description,
      main: "src/server.js",
      scripts: {
        start: "node src/server.js",
        dev: "nodemon src/server.js",
        test: "jest"
      },
      keywords: ["nodejs", "clean-architecture", "ddd", "api"],
      author: config.author,
      license: "MIT",
      dependencies: {
        express: "^4.18.2",
        cors: "^2.8.5",
        helmet: "^7.1.0",
        morgan: "^1.10.0",
        dotenv: "^16.3.1"
      },
      devDependencies: {
        nodemon: "^3.0.2",
        jest: "^29.7.0"
      },
      engines: {
        node: ">=16.0.0"
      }
    }, null, 2);
  }

  getReadmeTemplate(config) {
    return `# ${config.projectName}

${config.description}

## üèóÔ∏è Clean Architecture

Ce projet utilise **Clean Architecture** avec une s√©paration claire des responsabilit√©s.

### Structure des dossiers

\`\`\`
src/
‚îú‚îÄ‚îÄ domain/           # Couche m√©tier (entit√©s, value objects, repositories)
‚îú‚îÄ‚îÄ application/      # Cas d'usage et services applicatifs
‚îú‚îÄ‚îÄ infrastructure/   # Impl√©mentations techniques (DB, HTTP, etc.)
‚îú‚îÄ‚îÄ presentation/     # Contr√¥leurs, routes, middleware
‚îî‚îÄ‚îÄ shared/           # Utilitaires et erreurs partag√©es
\`\`\`

## üöÄ Installation

\`\`\`bash
npm install
\`\`\`

## üîß Configuration

1. Copiez \`.env.example\` vers \`.env\`
2. Configurez vos variables d'environnement

## üèÉ‚Äç‚ôÇÔ∏è D√©marrage

\`\`\`bash
# D√©veloppement
npm run dev

# Production
npm start
\`\`\`

## üë®‚Äçüíª Auteur

${config.author}

---

*G√©n√©r√© avec ‚ù§Ô∏è par Nexus CLI*
`;
  }

  getGitignoreTemplate() {
    return `# Dependencies
node_modules/
npm-debug.log*

# Environment variables
.env

# Logs
logs
*.log

# Coverage directory
coverage/

# IDE
.vscode/
.idea/

# OS
.DS_Store
Thumbs.db
`;
  }

  getAppJsTemplate(config) {
    const className = this.generateClassName(config.projectName);
    return `const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
require('dotenv').config();

const routes = require('./presentation/routes');

class ${className}App {
  constructor() {
    this.app = express();
    this.port = process.env.PORT || 3000;
    this.setupMiddleware();
    this.setupRoutes();
  }

  setupMiddleware() {
    this.app.use(helmet());
    this.app.use(cors());
    this.app.use(morgan('combined'));
    this.app.use(express.json());
    this.app.use(express.urlencoded({ extended: true }));
  }

  setupRoutes() {
    this.app.use('/api', routes);
    
    this.app.get('/health', (req, res) => {
      res.status(200).json({ status: 'OK', timestamp: new Date().toISOString() });
    });
  }

  start() {
    this.app.listen(this.port, () => {
      console.log(\`üöÄ ${className} (Clean Architecture) d√©marr√© sur le port \${this.port}\`);
    });
  }
}

module.exports = ${className}App;
`;
  }

  getServerJsTemplate(config) {
    const className = this.generateClassName(config.projectName);
    return `const ${className}App = require('./app');

const app = new ${className}App();
app.start();
`;
  }

  getEntityBaseTemplate(config) {
    return `/**
 * Entit√© de base pour le domaine m√©tier
 */
class BaseEntity {
  constructor(id) {
    if (this.constructor === BaseEntity) {
      throw new Error('BaseEntity est une classe abstraite');
    }
    this.id = id;
    this.createdAt = new Date();
    this.updatedAt = new Date();
  }

  /**
   * Valide l'entit√©
   */
  validate() {
    throw new Error('La m√©thode validate() doit √™tre impl√©ment√©e');
  }

  /**
   * Met √† jour l'entit√©
   */
  update(data) {
    Object.assign(this, data);
    this.updatedAt = new Date();
  }

  /**
   * Convertit l'entit√© en objet simple
   */
  toJSON() {
    return Object.assign({}, this);
  }
}

module.exports = BaseEntity;
`;
  }

  getUseCaseBaseTemplate(config) {
    return `/**
 * Cas d'usage de base
 */
class BaseUseCase {
  constructor() {
    if (this.constructor === BaseUseCase) {
      throw new Error('BaseUseCase est une classe abstraite');
    }
  }

  /**
   * Ex√©cute le cas d'usage
   */
  async execute(input) {
    throw new Error('La m√©thode execute() doit √™tre impl√©ment√©e');
  }

  /**
   * Valide les donn√©es d'entr√©e
   */
  validateInput(input) {
    return { isValid: true, errors: [] };
  }

  /**
   * G√®re les erreurs
   */
  handleError(error) {
    console.error('Erreur dans le cas d\'usage:', error);
    throw error;
  }
}

module.exports = BaseUseCase;
`;
  }

  getRepositoryBaseTemplate(config) {
    return `/**
 * Repository de base pour l'acc√®s aux donn√©es
 */
class BaseRepository {
  constructor() {
    if (this.constructor === BaseRepository) {
      throw new Error('BaseRepository est une classe abstraite');
    }
  }

  /**
   * Trouve une entit√© par ID
   */
  async findById(id) {
    throw new Error('La m√©thode findById() doit √™tre impl√©ment√©e');
  }

  /**
   * Trouve toutes les entit√©s
   */
  async findAll() {
    throw new Error('La m√©thode findAll() doit √™tre impl√©ment√©e');
  }

  /**
   * Sauvegarde une entit√©
   */
  async save(entity) {
    throw new Error('La m√©thode save() doit √™tre impl√©ment√©e');
  }

  /**
   * Supprime une entit√©
   */
  async delete(id) {
    throw new Error('La m√©thode delete() doit √™tre impl√©ment√©e');
  }
}

module.exports = BaseRepository;
`;
  }

  getControllerBaseTemplate(config) {
    return `/**
 * Contr√¥leur de base pour la pr√©sentation
 */
class BaseController {
  /**
   * R√©ponse de succ√®s
   */
  success(res, data, message = 'Op√©ration r√©ussie', statusCode = 200) {
    return res.status(statusCode).json({
      success: true,
      message,
      data,
      timestamp: new Date().toISOString()
    });
  }

  /**
   * R√©ponse d'erreur
   */
  error(res, message = 'Une erreur est survenue', statusCode = 500) {
    return res.status(statusCode).json({
      success: false,
      message,
      timestamp: new Date().toISOString()
    });
  }

  /**
   * Gestionnaire d'erreur asynchrone
   */
  asyncHandler(fn) {
    return (req, res, next) => {
      Promise.resolve(fn(req, res, next)).catch(next);
    };
  }
}

module.exports = BaseController;
`;
  }

  getRoutesIndexTemplate(config) {
    return `const express = require('express');
const router = express.Router();

router.get('/', (req, res) => {
  res.json({ 
    message: 'API ${config.projectName} - Clean Architecture',
    architecture: 'Clean Architecture',
    layers: ['Domain', 'Application', 'Infrastructure', 'Presentation']
  });
});

module.exports = router;
`;
  }
}

module.exports = { CleanArchitecture }; 